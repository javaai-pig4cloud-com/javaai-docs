---
title: 'Deepseek4jå¿«é€Ÿå¼€å‘RAG'
---

## å¿«é€Ÿä¸Šæ‰‹

æœ¬æ–‡ç« å°†å¸¦é¢†å¤§å®¶ä»é›¶å¼€å§‹æ„å»ºä¸€ä¸ªåŸºç¡€ RAG ç³»ç»Ÿã€‚é€šè¿‡ç™½ç›’ç¼–ç çš„æ–¹å¼ï¼Œä¸ä»…èƒ½æ·±å…¥ç†è§£ RAG çš„æ ¸å¿ƒåŸç†ï¼Œè¿˜å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚çµæ´»è°ƒæ•´å’Œä¼˜åŒ–å„ä¸ªç¯èŠ‚ã€‚**ç›¸æ¯”ç›´æ¥ä½¿ç”¨ç°æœ‰çš„å¼€æº RAG äº§å“ï¼Œè¿™ç§æ–¹å¼èƒ½è®©æˆ‘ä»¬æ›´å¥½åœ°æŒæ§ç³»ç»Ÿè¡Œä¸ºï¼Œå®ç°æ›´ç²¾å‡†çš„çŸ¥è¯†æ£€ç´¢å’Œé—®ç­”æ•ˆæœã€‚** 

<img src='https://minio.pigx.vip/oss/202502/1739407145.png' alt='1739407145'/>

### 1. ç¯å¢ƒå‡†å¤‡

åœ¨å¼€å§‹æ„å»º RAG ç³»ç»Ÿä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡ä»¥ä¸‹ç¯å¢ƒï¼š

#### 1.1 Ollama æ¨¡å‹å‡†å¤‡

é¦–å…ˆå®‰è£… [Ollama](https://ollama.ai/)ï¼Œç„¶åä¸‹è½½ä»¥ä¸‹å¿…è¦çš„æ¨¡å‹ï¼š

```bash
# ä¸‹è½½æ¨ç†æ¨¡å‹ - ç”¨äºç†è§£å’Œç”Ÿæˆå›ç­”
ollama run deepseek-r1:14b

# ä¸‹è½½å‘é‡æ¨¡å‹ - ç”¨äºæ–‡æœ¬å‘é‡åŒ–
ollama pull bge-m3:latest
```

#### 1.2 å‘é‡æ•°æ®åº“å‡†å¤‡

æœ¬æ–‡ä½¿ç”¨ Milvus ä½œä¸ºå‘é‡æ•°æ®åº“ï¼Œä½ å¯ä»¥é€‰æ‹©ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€è¿›è¡Œå®‰è£…ï¼š

**æ–¹å¼ä¸€ï¼šä½¿ç”¨milvus æµ‹è¯•ç¯å¢ƒ**
- è®¿é—® Zilliz Cloud ä¸­æ–‡ç‰ˆï¼šhttps://cloud.zilliz.com.cn
- è·å–è¿æ¥ä¿¡æ¯ï¼ˆåç»­é…ç½®éœ€è¦ç”¨åˆ°ï¼‰

**æ–¹å¼äºŒï¼šDocker å®‰è£…**

```bash
# 1. ä¸‹è½½å®‰è£…è„šæœ¬
curl -sfL https://raw.githubusercontent.com/milvus-io/milvus/master/scripts/standalone_embed.sh -o standalone_embed.sh

# 2. å¯åŠ¨ Docker å®¹å™¨
bash standalone_embed.sh start
```
> æ³¨æ„ï¼šå¦‚æœé€‰æ‹© Docker å®‰è£…æ–¹å¼ï¼Œè¯·ç¡®ä¿ä½ çš„ç½‘ç»œç¯å¢ƒèƒ½å¤Ÿæ­£å¸¸è®¿é—® Githubã€‚

- åˆå§‹åŒ–å‘é‡æ•°æ®ï¼šåˆ›å»ºæœ¬æ¬¡çŸ¥è¯†åº“å­˜å‚¨ã€è·å–é“¾æ¥ä¿¡æ¯å’Œè¡¨ä¿¡æ¯ï¼š
<img src='https://minio.pigx.vip/oss/202502/1739410521.png' alt='1739410521'/>


#### 1.3 é¡¹ç›®ä¾èµ–

åœ¨ä½ çš„ Maven é¡¹ç›®ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼š

```xml
<!-- é“¾æ¥ milvus SDK-->
<dependency>
    <groupId>io.milvus</groupId>
    <artifactId>milvus-sdk-java</artifactId>
    <version>2.5.3</version>
</dependency>
```

#### application.yml  é…ç½®

```yml
# æ¨ç†æ¨¡å‹é“¾æ¥ä¿¡æ¯
deepseek:
  base-url: http://127.0.0.1:11434/v1
  model: deepseek-r1:14b
  api-key: ollama-local
# å‘é‡æ¨¡å‹é“¾æ¥ä¿¡æ¯
embedding:
  api-key: ${deepseek.api-key}
  base-url: ${deepseek.base-url}
  model: bge-m3:latest
```


### 2. åˆå§‹åŒ–ç§æœ‰çŸ¥è¯†

åœ¨æ„å»º RAG ç³»ç»Ÿæ—¶ï¼Œç¬¬ä¸€æ­¥æ˜¯å°†å·²æœ‰çš„çŸ¥è¯†å†…å®¹è½¬æ¢ä¸ºå‘é‡å½¢å¼å¹¶å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“ä¸­ã€‚

#### 2.1 åˆ›å»ºé“¾æ¥ é“¾æ¥å®¢æˆ·ç«¯

```java
// 1. Connect to Milvus server
ConnectConfig connectConfig = ConnectConfig.builder()
        .uri(CLUSTER_ENDPOINT) // 1.2 è·å–çš„ Milvus é“¾æ¥ç«¯ç‚¹
        .token(TOKEN)  // 1.2 è·å–çš„ Milvus é“¾æ¥ä¿¡æ¯
        .build();

MilvusClientV2 milvusClientV2 = new MilvusClientV2(connectConfig);
```

#### 2.2 å‡†å¤‡èµ„æ–™å¹¶å‘é‡åŒ–ä¸Šä¼ 

ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•å¤„ç†æ–‡æœ¬èµ„æ–™ã€‚å¯¹äº Office æ–‡æ¡£ã€å›¾ç‰‡ã€PDFã€éŸ³è§†é¢‘ç­‰å…¶ä»–æ ¼å¼çš„æ–‡ä»¶å¤„ç†ï¼Œdeepseek4j æä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œè¯¦ç»†ä½¿ç”¨æ–¹æ³•è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£: https://javaai.pig4cloud.com/deepseekã€‚

```java
@Autowired
EmbeddingClient embeddingClient;

{
    // è¿™é‡Œä»¥ 2025æœ€æ–°çš„æˆ‘å¸ä¿å¯†æ¡ä¾‹æ¼”ç¤ºï¼Œå¯ä»¥æ¢æˆä½ è‡ªå·±çš„
    String law = FileUtil.readString("/Users/lengleng/Downloads/law.txt", Charset.defaultCharset());
    String[] lawSplits = StrUtil.split(law, 400);


    List<JsonObject> data = new ArrayList<>();
    for (String lawSplit : lawSplits) {
        List<Float> floatList = embeddingClient.embed(lawSplit);

        JsonObject jsonObject = new JsonObject();

        // å°† List<Float> è½¬æ¢ä¸º JsonArray
        JsonArray jsonArray = new JsonArray();
        for (Float value : floatList) {
            jsonArray.add(value);
        }
        jsonObject.add("vector", jsonArray);
        jsonObject.addProperty("text", lawSplit);

        data.add(jsonObject);
    }

    InsertReq insertReq = InsertReq.builder()
            .collectionName("deepseek4j_test")
            .data(data)
            .build();

    milvusClientV2.insert(insertReq);
}
```

### 3. åˆ›å»º RAG æ¥å£ 

```java
@GetMapping(value = "/chat", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<ChatCompletionResponse> chat(String prompt) {
    MilvusClientV2 milvusClientV2 = new MilvusClientV2(connectConfig);

    List<Float> floatList = embeddingClient.embed(prompt);

    SearchReq searchReq = SearchReq.builder()
            .collectionName("deepseek4j_test")
            .data(Collections.singletonList(new FloatVec(floatList)))
            .outputFields(Collections.singletonList("text"))
            .topK(3)
            .build();

    SearchResp searchResp = milvusClientV2.search(searchReq);

    List<String> resultList = new ArrayList<>();
    List<List<SearchResp.SearchResult>> searchResults = searchResp.getSearchResults();
    for (List<SearchResp.SearchResult> results : searchResults) {
        System.out.println("TopK results:");
        for (SearchResp.SearchResult result : results) {
            resultList.add(result.getEntity().get("text").toString());
        }
    }


    ChatCompletionRequest request = ChatCompletionRequest.builder()
            // æ ¹æ®æ¸ é“æ¨¡å‹åç§°åŠ¨æ€ä¿®æ”¹è¿™ä¸ªå‚æ•°
            .model("deepseek-r1:14b")
            .addUserMessage(String.format("ä½ è¦æ ¹æ®ç”¨æˆ·è¾“å…¥çš„é—®é¢˜ï¼š%s \n \n å‚è€ƒå¦‚ä¸‹å†…å®¹ï¼š %s  \n\n æ•´ç†å¤„ç†æœ€ç»ˆç»“æœ", prompt, resultList)).build();

    return deepSeekClient.chatFluxCompletion(request);
}
```

### å‰ç«¯æµ‹è¯•

<img src='https://minio.pigx.vip/oss/202502/1739410900.png' alt='1739410900'/>


## æ€»ç»“

æœ¬æ–‡é€šè¿‡ä»¥ä¸‹æ ¸å¿ƒæ­¥éª¤å¿«é€Ÿæ„å»ºäº†åŸºç¡€ RAG ç³»ç»Ÿï¼š

1. ç¯å¢ƒå‡†å¤‡ï¼šéƒ¨ç½²æ¨ç†æ¨¡å‹å’Œå‘é‡æ¨¡å‹
2. çŸ¥è¯†åº“æ„å»ºï¼šå‘é‡åŒ–å­˜å‚¨
3. æ£€ç´¢å¢å¼ºï¼šé€šè¿‡è¯­ä¹‰æœç´¢è·å–å…³è”çŸ¥è¯†
4. æ¨ç†ç”Ÿæˆï¼šç»“åˆä¸Šä¸‹æ–‡ç”Ÿæˆæœ€ç»ˆå›ç­”

è¦è®© RAG ç³»ç»Ÿè¾¾åˆ°ç”Ÿäº§å¯ç”¨æ°´å¹³ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–å’Œå®Œå–„ï¼š

1. æ£€ç´¢ç­–ç•¥ä¼˜åŒ–ï¼šç»“åˆå…³é”®è¯å’Œè¯­ä¹‰çš„æ··åˆæ£€ç´¢ï¼Œæé«˜å¬å›å‡†ç¡®åº¦
2. é‡æ’åºä¼˜åŒ–ï¼šå¯¹æ£€ç´¢ç»“æœè¿›è¡ŒäºŒæ¬¡æ’åºï¼Œç¡®ä¿æœ€ç›¸å…³å†…å®¹æ’åœ¨å‰é¢
3. æç¤ºè¯å·¥ç¨‹ï¼šä¼˜åŒ– Prompt æ¨¡æ¿ï¼Œå¼•å¯¼æ¨¡å‹ç”Ÿæˆæ›´å‡†ç¡®çš„å›ç­”
4. çŸ¥è¯†åº“ç®¡ç†ï¼šå®šæœŸæ›´æ–°å’Œç»´æŠ¤çŸ¥è¯†åº“ï¼Œä¿è¯æ•°æ®æ—¶æ•ˆæ€§
5. æ€§èƒ½è°ƒä¼˜ï¼šä¼˜åŒ–å‘é‡æ£€ç´¢å’Œæ¨¡å‹æ¨ç†çš„æ€§èƒ½

## å•†ä¸šåŒ–é€‰æ‹©
<Card title="PIG AIåº”ç”¨å¼€å‘å¹³å° | é€‚åˆä¸­å¤§å‹ä¼ä¸šæ„å»ºè‡ªä¸»å¯æ§çš„AIä¸­å°" icon="link" href="https://ai.pig4cloud.com">
**ä¸ºJavaå¼€å‘è€…æä¾›å…¨æ ˆå¼AIå·¥ç¨‹åŒ–è§£å†³æ–¹æ¡ˆ**ï¼Œå¼ºç±»å‹/é«˜å¯ç»´æŠ¤æ€§æ¶æ„ï¼Œå†…ç½®30+ä¸»æµå¤§æ¨¡å‹æ”¯æŒã€‚

- **ğŸ” çŸ¥è¯†å¼•æ“ä½“ç³»**ï¼šRAG çŸ¥è¯†å¼•æ“å…¨è‡ªåŠ¨åŒ–å¤šæ¨¡æ€è§£å†³æ–¹æ¡ˆ
- **ğŸ“ AI-OCR ä¸­æ¢**ï¼šå¤æ‚éæ ‡åœºæ™¯é«˜ç²¾åº¦è¯†åˆ«
- **âš™ï¸ ä¸šåŠ¡æ™ºèƒ½èåˆ**ï¼šå‡½æ•°ç¼–æ’ + Chat2SQLï¼Œæ— ç¼å¯¹æ¥ç°æœ‰ä¸šåŠ¡ç³»ç»Ÿ
- **ğŸ›¡ï¸ Nç»´é£æ§ä½“ç³»**ï¼šæ•æ„Ÿè¯/IP/Token/User è§„åˆ™æ§åˆ¶å¼•æ“
</Card>