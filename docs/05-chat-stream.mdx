---
title: Chat æµå¼è¾“å‡º
---

LangChain4J æ˜¯ä¸€ä¸ªå¼ºå¤§çš„åº“ï¼Œä¸“é—¨ç”¨äºä¸è¯­è¨€å­¦ä¹ æ¨¡å‹ï¼ˆLLMsï¼‰è¿›è¡Œäº¤äº’ã€‚å…¶æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€æ˜¯èƒ½å¤Ÿé€ä¸ªä»¤ç‰Œåœ°æµå¼ä¼ è¾“æ¥è‡ª LLMs çš„å“åº”ã€‚è¿™é¡¹åŠŸèƒ½æå¤§åœ°æå‡äº†ç”¨æˆ·ä½“éªŒï¼Œä½¿ç”¨æˆ·å¯ä»¥åœ¨æ¨¡å‹ç”Ÿæˆå®Œæ•´å“åº”å‰ï¼Œå®æ—¶è·å–éƒ¨åˆ†ä¿¡æ¯ã€‚

æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ LangChain4J å®ç°æµå¼èŠå¤©åŠŸèƒ½ã€‚

## æµå¼å“åº”å¤„ç†
### `StreamingChatResponseHandler` æ¥å£
æµå¼å“åº”çš„å…³é”®æ¥å£æ˜¯ `StreamingChatResponseHandler`ã€‚å®ƒå…è®¸å¼€å‘è€…å®šä¹‰åœ¨å“åº”ç”Ÿæˆè¿‡ç¨‹ä¸­çš„å„ä¸ªäº‹ä»¶çš„å¤„ç†é€»è¾‘ã€‚

```java
public interface StreamingChatResponseHandler<T> {

    void onPartialResponse(String partialResponse);
 
    void onCompleteResponse(ChatResponse completeResponse);

    void onError(Throwable error);
}
```

### äº‹ä»¶è¯´æ˜

+ **onNext(String token)**ï¼šæ¯å½“ç”Ÿæˆä¸‹ä¸€ä¸ªä»¤ç‰Œæ—¶è§¦å‘ï¼Œé€šå¸¸ç”¨äºå°†å®æ—¶ç”Ÿæˆçš„å†…å®¹åŠæ—¶åé¦ˆç»™å‰ç«¯ã€‚
+ **onComplete(Response response)**ï¼šå½“æ¨¡å‹ç”Ÿæˆå®Œæˆæ—¶è§¦å‘ã€‚æ­¤æ—¶è¿”å›ä¸€ä¸ªå®Œæ•´çš„ `Response` å¯¹è±¡ã€‚å¯¹äº `StreamingChatModel`ï¼Œ`T` ä¸º `AiMessage`ï¼›å¯¹äº `StreamingLanguageModel`ï¼Œ`T` ä¸º `String`ã€‚
+ **onError(Throwable error)**ï¼šå½“ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚

## å®ç°æµå¼èŠå¤©çš„åŸºæœ¬ç¤ºä¾‹
ä»¥ä¸‹æ˜¯ä½¿ç”¨ `StreamingChatModel` å®ç°æµå¼å¤„ç†çš„ç¤ºä¾‹ï¼š

```java
StreamingChatModel model = OpenAiStreamingChatModel.builder()
    ...
    .build();

/**
    * æµ‹è¯•æµå¼èŠå¤©æ¨¡å‹çš„åŸºæœ¬åŠŸèƒ½
    * éªŒè¯StreamingChatModelèƒ½å¦æ­£ç¡®å¤„ç†æµå¼å“åº”ï¼Œå¹¶é€šè¿‡å›è°ƒæ¥å£è·å–ç»“æœ
    */
@Test
void testStreamingChatModelWithCallback() throws InterruptedException {

    streamingChatLanguageModel.chat("hello, åŒ—äº¬æœ‰ä»€ä¹ˆå¥½åƒçš„ï¼Ÿ", new StreamingChatResponseHandler() {
        @Override
        public void onPartialResponse(String token) {
            System.out.println("onNext: " + token);
        }

        @Override
        public void onCompleteResponse(ChatResponse chatResponse) {

        }

        @Override
        public void onError(Throwable throwable) {

        }
    });

}
```

### ç¤ºä¾‹è¯´æ˜
1. **æ¨¡å‹åˆå§‹åŒ–**ï¼šé€šè¿‡ `OpenAiStreamingChatModel.builder()` åˆ›å»ºä¸€ä¸ªæµå¼æ¨¡å‹å®ä¾‹ï¼Œå¹¶ä»ç¯å¢ƒå˜é‡ä¸­è·å– API å¯†é’¥ã€‚
2. **ç”¨æˆ·è¾“å…¥**ï¼šå®šä¹‰ç”¨æˆ·è¾“å…¥æ¶ˆæ¯ï¼Œæ­¤å¤„ä¸º"è®²ä¸ªç¬‘è¯"ã€‚
3. **å¤„ç†å“åº”**ï¼šä¼ é€’å®ç°äº† `StreamingChatResponseHandler` çš„åŒ¿åç±»ï¼Œåˆ†åˆ«å®šä¹‰ `onPartialResponse`ã€`onCompleteResponse` å’Œ `onError` çš„å¤„ç†é€»è¾‘ã€‚

## ä½¿ç”¨ `TokenStream` è¿›è¡Œæµå¼å¤„ç†
é™¤äº† `StreamingChatResponseHandler`ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ `TokenStream` é€ä¸ªä»¤ç‰Œæµå¼å¤„ç†å“åº”ã€‚

### ç¤ºä¾‹ä»£ç 
```java
interface Assistant {

    TokenStream chat(String message);
}

StreamingChatModel model = OpenAiStreamingChatModel.builder()
    ...
    .build();

Assistant assistant = AiServices.create(Assistant.class, model);

TokenStream tokenStream = assistant.chat("åŒ—äº¬æœ‰ä»€ä¹ˆå¥½åƒçš„ï¼Ÿ");

tokenStream.onPartialResponse(System.out::println)
        .onCompleteResponse(System.out::println)
        .onError(Throwable::printStackTrace)
        .start();
```

### ç¤ºä¾‹è¯´æ˜
1. **æ¥å£å®šä¹‰**ï¼š`Assistant` æ¥å£å®šä¹‰äº† `chat` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å› `TokenStream`ã€‚
2. **æ¨¡å‹åˆå§‹åŒ–**ï¼šåŒæ ·åœ°ï¼Œé€šè¿‡ `OpenAiStreamingChatModel.builder()` åˆå§‹åŒ–æ¨¡å‹ã€‚
3. **TokenStream å¤„ç†**ï¼šå¯¹è¿”å›çš„ `TokenStream` è¿›è¡Œè®¢é˜…ï¼Œåˆ†åˆ«å¤„ç† `onNext`ã€`onComplete` å’Œ `onError` äº‹ä»¶ï¼Œå¹¶å¯åŠ¨æµå¼å¤„ç†ã€‚

## ä½¿ç”¨ `Flux` è¿›è¡Œæµå¼å¤„ç†
é™¤äº† `TokenStream`ï¼Œæ‚¨è¿˜å¯ä»¥é€šè¿‡ Reactor åº“ä¸­çš„ `Flux<String>` å®ç°å“åº”æµå¼ä¼ è¾“ã€‚ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦å¼•å…¥ `langchain4j-reactor` ä¾èµ–ã€‚

### Maven ä¾èµ–

```xml
<dependency>
    <groupId>dev.langchain4j</groupId>
    <artifactId>langchain4j-reactor</artifactId>
</dependency>
```

### ç¤ºä¾‹ä»£ç 
```java
interface Assistant {

  Flux<String> chat(String message);
}

StreamingChatModel model = OpenAiStreamingChatModel.builder()
    ...
    .build();

Assistant assistant = AiServices.create(Assistant.class, model);


@GetMapping("/chat")
public Flux<String> chat(@RequestParam("message") String message) {
    return assistant.chat("è®²ä¸ªç¬‘è¯");
}
```

### ç¤ºä¾‹è¯´æ˜

1. **æ¥å£å®šä¹‰**ï¼š`Assistant` æ¥å£å®šä¹‰äº†è¿”å› `Flux<String>` çš„ `chat` æ–¹æ³•ã€‚
2. **æ¨¡å‹åˆå§‹åŒ–**ï¼šä½¿ç”¨ä¸ä¹‹å‰ç›¸åŒçš„æ–¹å¼åˆå§‹åŒ–æ¨¡å‹ã€‚
3. **è®¢é˜…å¤„ç†**ï¼šä½¿ç”¨ `Flux.subscribe` æ¥å¤„ç†æ¯ä¸ªç”Ÿæˆçš„ä»¤ç‰Œã€é”™è¯¯å’Œå®Œæˆäº‹ä»¶ã€‚

## æ€»ç»“
LangChain4J æä¾›äº†ä¸€ç§é«˜æ•ˆä¸”çµæ´»çš„æ–¹å¼æ¥æµå¼ä¼ è¾“è¯­è¨€æ¨¡å‹çš„å“åº”ã€‚é€šè¿‡ `StreamingChatResponseHandler`ã€`TokenStream` æˆ– `Flux`ï¼Œå¼€å‘è€…å¯ä»¥å®ç°æµç•…çš„å®æ—¶å“åº”ä½“éªŒï¼Œä»è€Œæå‡åº”ç”¨çš„äº’åŠ¨æ€§å’Œå“åº”é€Ÿåº¦ã€‚

æµå¼å¤„ç†è®©ç”¨æˆ·æ— éœ€ç­‰å¾…å®Œæ•´å“åº”ç”Ÿæˆå³å¯è·å–éƒ¨åˆ†å†…å®¹ï¼Œå°¤å…¶é€‚ç”¨äºèŠå¤©æœºå™¨äººå’Œäº¤äº’å¼ AI åº”ç”¨çš„å¼€å‘ã€‚

<Card title="PIG AIåº”ç”¨å¼€å‘å¹³å° | é€‚åˆä¸­å¤§å‹ä¼ä¸šæ„å»ºè‡ªä¸»å¯æ§çš„AIä¸­å°" icon="link" href="https://ai.pig4cloud.com">
**ä¸ºJavaå¼€å‘è€…æä¾›å…¨æ ˆå¼AIå·¥ç¨‹åŒ–è§£å†³æ–¹æ¡ˆ**ï¼Œå¼ºç±»å‹/é«˜å¯ç»´æŠ¤æ€§æ¶æ„ï¼Œå†…ç½®30+ä¸»æµå¤§æ¨¡å‹æ”¯æŒã€‚

- **ğŸ” çŸ¥è¯†å¼•æ“ä½“ç³»**ï¼šRAG çŸ¥è¯†å¼•æ“å…¨è‡ªåŠ¨åŒ–å¤šæ¨¡æ€è§£å†³æ–¹æ¡ˆ
- **ğŸ“ AI-OCR ä¸­æ¢**ï¼šå¤æ‚éæ ‡åœºæ™¯é«˜ç²¾åº¦è¯†åˆ«
- **âš™ï¸ ä¸šåŠ¡æ™ºèƒ½èåˆ**ï¼šå‡½æ•°ç¼–æ’ + Chat2SQLï¼Œæ— ç¼å¯¹æ¥ç°æœ‰ä¸šåŠ¡ç³»ç»Ÿ
- **ğŸ›¡ï¸ Nç»´é£æ§ä½“ç³»**ï¼šæ•æ„Ÿè¯/IP/Token/User è§„åˆ™æ§åˆ¶å¼•æ“
</Card>

<Card title="æ–‡æ¡£æœ‰è¯¯ï¼Ÿè¯·ååŠ©ç¼–è¾‘" icon="pencil" href="https://github.com/javaai-pig4cloud-com/javaai-docs/edit/main/docs/05Chat Stream.mdx">
  å‘ç°æ–‡æ¡£é—®é¢˜ï¼Ÿç‚¹å‡»æ­¤å¤„ç›´æ¥åœ¨ GitHub ä¸Šç¼–è¾‘å¹¶æäº¤ PRï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹è¿›æ–‡æ¡£ï¼
</Card>

