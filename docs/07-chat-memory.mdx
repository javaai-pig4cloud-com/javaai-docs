---
title: Chat è®°å¿†ç¼“å­˜
---

<img src='https://minio.pigx.top/oss/202410/1728298660.png' alt='1728298660'/>

è®°å¿†ç¼“å­˜æ˜¯èŠå¤©ç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦ç»„ä»¶ï¼Œç”¨äºå­˜å‚¨å’Œç®¡ç†å¯¹è¯çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯è®©AIåŠ©æ‰‹èƒ½å¤Ÿ"è®°ä½"ä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼Œä»è€Œæä¾›è¿è´¯å’Œä¸ªæ€§åŒ–çš„å›å¤ã€‚

## 1. ç®€ä»‹

ChatMemoryæ˜¯ä¸€ä¸ªç”¨äºç®¡ç†èŠå¤©ä¸Šä¸‹æ–‡çš„ç»„ä»¶,å®ƒå¯ä»¥è§£å†³ä»¥ä¸‹é—®é¢˜:

- é˜²æ­¢ä¸Šä¸‹æ–‡è¶…å‡ºå¤§æ¨¡å‹çš„tokené™åˆ¶
- éš”ç¦»ä¸åŒç”¨æˆ·çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- ç®€åŒ–ChatMessageçš„ç®¡ç†


<img src='https://minio.pigx.top/oss/202410/1728219300.png' alt='1728219300'/>


## 2. æ ¸å¿ƒåŠŸèƒ½

- å®¹å™¨ç®¡ç†: ç®¡ç†ChatMessageçš„ç”Ÿå‘½å‘¨æœŸ
- æ·˜æ±°æœºåˆ¶: é˜²æ­¢å­˜å‚¨è¿‡å¤šæ¶ˆæ¯
- æŒä¹…åŒ–: é¿å…èŠå¤©ä¸Šä¸‹æ–‡ä¸¢å¤±

## 3. ChatMemoryå®ç°ç±»

LangChain4jæä¾›äº†ä¸¤ç§ä¸»è¦çš„ChatMemoryå®ç°ç±»,æ¯ç§éƒ½æœ‰å…¶ç‰¹å®šçš„ç”¨é€”å’Œä¼˜åŠ¿:

### 3.1 MessageWindowChatMemoryï¼ˆç®€å•å®ç°ï¼‰

è¿™æ˜¯ä¸€ä¸ªåŸºäºæ¶ˆæ¯æ•°é‡çš„ç®€å•å®ç°ã€‚å®ƒé‡‡ç”¨æ»‘åŠ¨çª—å£çš„æ–¹å¼,ä¿ç•™æœ€æ–°çš„Næ¡æ¶ˆæ¯,å¹¶æ·˜æ±°æ—§æ¶ˆæ¯ã€‚

**ç‰¹ç‚¹:**
- æ˜“äºç†è§£å’Œå®ç°
- åŸºäºæ¶ˆæ¯æ•°é‡è¿›è¡Œç®¡ç†
- é€‚ç”¨äºä¸éœ€è¦ç²¾ç¡®tokenæ§åˆ¶çš„åœºæ™¯

**ä½¿ç”¨ç¤ºä¾‹:**
```java
ChatMemory chatMemory = MessageWindowChatMemory.withMaxMessages(10);
```

### 3.2 TokenWindowChatMemoryï¼ˆå¤æ‚å®ç°ï¼‰

è¿™æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„å®ç°,å®ƒåŒæ ·é‡‡ç”¨æ»‘åŠ¨çª—å£çš„æ–¹å¼,ä½†ä¾§é‡äºä¿ç•™æœ€æ–°çš„tokens,è€Œä¸æ˜¯æ¶ˆæ¯æ•°é‡ã€‚

**ç‰¹ç‚¹:**
- æ›´ç²¾ç¡®çš„tokenæ§åˆ¶
- éœ€è¦ç»“åˆTokenizerè®¡ç®—ChatMessageçš„tokenæ•°é‡
- é€‚ç”¨äºéœ€è¦ä¸¥æ ¼æ§åˆ¶tokenä½¿ç”¨çš„åœºæ™¯

**ä½¿ç”¨ç¤ºä¾‹:**
```java
Tokenizer tokenizer = new OpenAiTokenizer(GPT_3_5_TURBO);
ChatMemory chatMemory = TokenWindowChatMemory.withMaxTokens(1000, tokenizer);
```

**æ³¨æ„:** ä½¿ç”¨TokenWindowChatMemoryéœ€è¦æä¾›ä¸€ä¸ªTokenizerå®ä¾‹,ç”¨äºè®¡ç®—æ¶ˆæ¯çš„tokenæ•°é‡ã€‚ä¸åŒçš„è¯­è¨€æ¨¡å‹å¯èƒ½éœ€è¦ä¸åŒçš„Tokenizerã€‚

## 4. å®ç°æ–¹å¼


### 4.0 Ai Services å®šä¹‰

```java

public interface ChatAssistant {

    /**
     * èŠå¤©
     *
     * @param message æ¶ˆæ¯
     * @return {@link String }
     */
    String chat(String message);


    /**
     * èŠå¤©
     *
     * @param userId  ç”¨æˆ· ID  (æ ¹æ®IDéš”ç¦»è®°å¿†)
     * @param message æ¶ˆæ¯
     * @return {@link String }
     */
    String chat(@MemoryId Long userId, @UserMessage String message);
}
```

### 4.1 å…±äº«ChatMemory

é€‚ç”¨äºå•ç”¨æˆ·åœºæ™¯ã€‚

```java
ChatMemory chatMemory = MessageWindowChatMemory.withMaxMessages(10);
ChatAssistant assistant = AiServices.builder(ChatAssistant.class)
        .chatLanguageModel(chatLanguageModel)
        .chatMemory(chatMemory)
        .build();

String answer1 = assistant.chat("ä½ å¥½ï¼æˆ‘çš„åå­—æ˜¯å†·å†·.");
String answer2 = assistant.chat("æˆ‘çš„åå­—æ˜¯ä»€ä¹ˆï¼Ÿ");
```

### 4.2 ç‹¬äº«ChatMemory

é€‚ç”¨äºå¤šç”¨æˆ·åœºæ™¯ã€‚

```java
ChatAssistant assistant = AiServices.builder(ChatAssistant.class)
        .chatLanguageModel(chatLanguageModel)
        // æ³¨æ„æ¯ä¸ªmemoryIdå¯¹åº”åˆ›å»ºä¸€ä¸ªChatMemory
        .chatMemoryProvider(memoryId -> MessageWindowChatMemory.withMaxMessages(10))
        .build();


assistant.chat(1L, "ä½ å¥½ï¼æˆ‘çš„åå­—æ˜¯å†·å†·1.");
assistant.chat(2L, "ä½ å¥½ï¼æˆ‘çš„åå­—æ˜¯å†·å†·2.");

String chat = assistant.chat(1L, "æˆ‘çš„åå­—æ˜¯ä»€ä¹ˆ");
System.out.println(chat);
chat = assistant.chat(2L, "æˆ‘çš„åå­—æ˜¯ä»€ä¹ˆ");
System.out.println(chat);
```

## 5. è‡ªå®šä¹‰æŒä¹…åŒ–

å¦‚éœ€è‡ªå®šä¹‰æŒä¹…åŒ–æ–¹å¼,å¯ä»¥å®ç°ChatMemoryStoreæ¥å£:

```java
public class PersistentChatMemoryStore implements ChatMemoryStore {
    private final DB db = DBMaker.fileDB("./chat-memory.db").transactionEnable().make();
    private final Map<Integer, String> map = db.hashMap("messages", INTEGER, STRING).createOrOpen();

    @Override
    public List<ChatMessage> getMessages(Object memoryId) {
        String json = map.get((int) memoryId);
        return messagesFromJson(json);
    }

    @Override
    public void updateMessages(Object memoryId, List<ChatMessage> messages) {
        String json = messagesToJson(messages);
        map.put((int) memoryId, json);
        db.commit();
    }

    @Override
    public void deleteMessages(Object memoryId) {
        map.remove((int) memoryId);
        db.commit();
    }
}
```

## 6. æ³¨æ„äº‹é¡¹

- SystemMessageä¼šè¢«ç‰¹æ®Šå¤„ç†,å§‹ç»ˆä¿ç•™ä¸”åªå…è®¸ä¸€ä¸ª
- å·¥å…·æ¶ˆæ¯(å¦‚å‡½æ•°è°ƒç”¨)éœ€è¦æˆå¯¹å¤„ç†
- é»˜è®¤å®ç°æ˜¯åŸºäºå†…å­˜çš„,å¦‚éœ€æŒä¹…åŒ–éœ€è‡ªè¡Œå®ç°

## 7. æœ€ä½³å®è·µ

1. æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©å…±äº«æˆ–ç‹¬äº«ChatMemory
2. åˆç†é€‰æ‹©ChatMemoryå®ç°ç±»:
   - å¯¹äºç®€å•åœºæ™¯,ä½¿ç”¨MessageWindowChatMemory
   - å¯¹äºéœ€è¦ç²¾ç¡®æ§åˆ¶tokençš„åœºæ™¯,ä½¿ç”¨TokenWindowChatMemory
3. åˆç†è®¾ç½®æ¶ˆæ¯çª—å£å¤§å°æˆ–tokené™åˆ¶,å¹³è¡¡ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œæ€§èƒ½
4. é’ˆå¯¹å¤šç”¨æˆ·åœºæ™¯,ä½¿ç”¨ç‹¬äº«ChatMemoryå¹¶æä¾›å”¯ä¸€çš„memoryId
5. å¦‚æœ‰æŒä¹…åŒ–éœ€æ±‚,è‡ªå®šä¹‰å®ç°ChatMemoryStoreæ¥å£
6. æ³¨æ„å¤„ç†ç‰¹æ®Šæ¶ˆæ¯ç±»å‹,å¦‚SystemMessageå’Œå·¥å…·æ¶ˆæ¯

é€šè¿‡åˆç†ä½¿ç”¨ChatMemory,å¯ä»¥æœ‰æ•ˆç®¡ç†èŠå¤©ä¸Šä¸‹æ–‡,æå‡å¤§æ¨¡å‹åº”ç”¨çš„ç”¨æˆ·ä½“éªŒå’Œæ€§èƒ½ã€‚é€‰æ‹©åˆé€‚çš„ChatMemoryå®ç°ç±»å’Œé…ç½®å¯ä»¥å¸®åŠ©æ‚¨åœ¨ä¿ç•™å¿…è¦ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œæ§åˆ¶èµ„æºä½¿ç”¨ä¹‹é—´å–å¾—å¹³è¡¡ã€‚

<Card title="PIG AIåº”ç”¨å¼€å‘å¹³å° | é€‚åˆä¸­å¤§å‹ä¼ä¸šæ„å»ºè‡ªä¸»å¯æ§çš„AIä¸­å°" icon="link" href="https://ai.pig4cloud.com">
**ä¸ºJavaå¼€å‘è€…æä¾›å…¨æ ˆå¼AIå·¥ç¨‹åŒ–è§£å†³æ–¹æ¡ˆ**ï¼Œå¼ºç±»å‹/é«˜å¯ç»´æŠ¤æ€§æ¶æ„ï¼Œå†…ç½®30+ä¸»æµå¤§æ¨¡å‹æ”¯æŒã€‚

- **ğŸ” çŸ¥è¯†å¼•æ“ä½“ç³»**ï¼šRAG çŸ¥è¯†å¼•æ“å…¨è‡ªåŠ¨åŒ–å¤šæ¨¡æ€è§£å†³æ–¹æ¡ˆ
- **ğŸ“ AI-OCR ä¸­æ¢**ï¼šå¤æ‚éæ ‡åœºæ™¯é«˜ç²¾åº¦è¯†åˆ«
- **âš™ï¸ ä¸šåŠ¡æ™ºèƒ½èåˆ**ï¼šå‡½æ•°ç¼–æ’ + Chat2SQLï¼Œæ— ç¼å¯¹æ¥ç°æœ‰ä¸šåŠ¡ç³»ç»Ÿ
- **ğŸ›¡ï¸ Nç»´é£æ§ä½“ç³»**ï¼šæ•æ„Ÿè¯/IP/Token/User è§„åˆ™æ§åˆ¶å¼•æ“
</Card>

<Card title="æ–‡æ¡£æœ‰è¯¯ï¼Ÿè¯·ååŠ©ç¼–è¾‘" icon="pencil" href="https://github.com/javaai-pig4cloud-com/javaai-docs/edit/main/docs/07Chat è®°å¿†.mdx">
  å‘ç°æ–‡æ¡£é—®é¢˜ï¼Ÿç‚¹å‡»æ­¤å¤„ç›´æ¥åœ¨ GitHub ä¸Šç¼–è¾‘å¹¶æäº¤ PRï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹è¿›æ–‡æ¡£ï¼
</Card>



