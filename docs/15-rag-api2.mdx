---
title: RAG API å¢å¼º
---

<img src='https://minio.pigx.top/oss/202410/1728458493.png' alt='1728458493'/>

### æ£€ç´¢å¢å¼ºå™¨ï¼ˆRetrieval Augmentorï¼‰

`RetrievalAugmentor` æ˜¯ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æµç¨‹çš„æ ¸å¿ƒï¼Œå®ƒé€šè¿‡ä»ä¸åŒçš„æ•°æ®æºä¸­æ£€ç´¢ç›¸å…³å†…å®¹æ¥å¢å¼ºç”¨æˆ·çš„æ¶ˆæ¯ã€‚

åœ¨åˆ›å»º AI service æ—¶ï¼Œå¯ä»¥æŒ‡å®š `RetrievalAugmentor` å®ä¾‹ï¼š

```java

@Bean
public ChatAssistant assistant(ChatModel chatModel, EmbeddingStore<TextSegment> embeddingStore) {

    DefaultRetrievalAugmentor retrievalAugmentor = DefaultRetrievalAugmentor.builder()
            .queryTransformer()  // æŸ¥è¯¢å¢å¼º
            .contentRetriever() // å†…å®¹æº å•ä¸ªç›´æ¥é…ç½®
            .queryRouter(new DefaultQueryRouter())// å¤šä¸ªå†…å®¹æºï¼Œè·¯ç”±
            .contentAggregator() // åŒ¹é…ç»“æœèšåˆ
            .contentInjector()   // ç»“æœæç¤ºè¯æ³¨å…¥
            .executor()  // å¹¶è¡ŒåŒ–
            .build();

    return AiServices.builder(ChatAssistant.class)
            .chatModel(chatModel)
            .chatMemory(MessageWindowChatMemory.withMaxMessages(10))
            .retrievalAugmentor(retrievalAugmentor)
            .build();
}
```

æ¯æ¬¡è°ƒç”¨ AI æœåŠ¡æ—¶ï¼Œéƒ½ä¼šè‡ªåŠ¨ä½¿ç”¨è¿™ä¸ªå¢å¼ºå™¨æ¥å¤„ç†å½“å‰çš„ç”¨æˆ·æ¶ˆæ¯ã€‚ä½ å¯ä»¥ä½¿ç”¨é»˜è®¤çš„å¢å¼ºå™¨å®ç°ï¼Œä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰ã€‚

### é»˜è®¤æ£€ç´¢å¢å¼ºå™¨

LangChain4j æä¾›äº†å¼€ç®±å³ç”¨çš„ `RetrievalAugmentor` å®ç°ï¼š`DefaultRetrievalAugmentor`ã€‚å®ƒé€‚ç”¨äºå¤§å¤šæ•°çš„ RAG åœºæ™¯ã€‚è¿™ä¸ªå®ç°çš„çµæ„Ÿæ¥æºäº [LangChain åšå®¢æ–‡ç« ](https://blog.langchain.dev/deconstructing-rag) å’Œ [ç›¸å…³è®ºæ–‡](https://arxiv.org/abs/2312.10997)ã€‚

### æŸ¥è¯¢ï¼ˆQueryï¼‰

`Query` ä»£è¡¨ç”¨æˆ·çš„æŸ¥è¯¢è¯·æ±‚ï¼ŒåŒ…å«æŸ¥è¯¢çš„æ–‡æœ¬ä»¥åŠç›¸å…³çš„å…ƒæ•°æ®ã€‚

#### æŸ¥è¯¢å…ƒæ•°æ®

`Query` ä¸­çš„ `Metadata` åŒ…å«åœ¨ RAG æµç¨‹ä¸­æœ‰ç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š
- `Metadata.userMessage()`ï¼šè¡¨ç¤ºç”¨æˆ·è¾“å…¥çš„åŸå§‹æ¶ˆæ¯ã€‚
- `Metadata.chatMemoryId()`ï¼šä¸€ä¸ªç”¨äºæ ‡è¯†ç”¨æˆ·çš„IDï¼Œå¯ä»¥åº”ç”¨åœ¨æ•°æ®è®¿é—®é™åˆ¶æˆ–è¿‡æ»¤ä¸Šã€‚
- `Metadata.chatMemory()`ï¼šä¹‹å‰çš„æ‰€æœ‰å¯¹è¯æ¶ˆæ¯ï¼Œç”¨äºç†è§£æŸ¥è¯¢çš„ä¸Šä¸‹æ–‡ã€‚

### æŸ¥è¯¢è½¬æ¢å™¨ï¼ˆQuery Transformerï¼‰

`QueryTransformer` ç”¨äºå°†åŸå§‹æŸ¥è¯¢è½¬æ¢ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªæ–°çš„æŸ¥è¯¢ï¼Œä»¥æé«˜æ£€ç´¢çš„å‡†ç¡®æ€§ã€‚å¸¸è§çš„æŸ¥è¯¢ä¼˜åŒ–æ–¹å¼åŒ…æ‹¬ï¼š
- æŸ¥è¯¢å‹ç¼©ï¼šå‹ç¼©å†—é•¿çš„å¯¹è¯ï¼Œç”Ÿæˆä¸€ä¸ªç®€æ˜çš„æŸ¥è¯¢ã€‚
- æŸ¥è¯¢æ‰©å±•ï¼šå°†ç®€å•çš„æŸ¥è¯¢æ‰©å±•ä¸ºå¤šä¸ªç›¸å…³çš„æŸ¥è¯¢ã€‚
- æŸ¥è¯¢é‡å†™ï¼šå¯¹æŸ¥è¯¢è¿›è¡Œæ”¹å†™ï¼Œä½¿å…¶æ›´é€‚åˆæ£€ç´¢ã€‚

**ç¤ºä¾‹ï¼š**
```java
QueryTransformer transformer = new CompressingQueryTransformer();
```

#### é»˜è®¤æŸ¥è¯¢è½¬æ¢å™¨

`DefaultQueryTransformer` æ˜¯æœ€ç®€å•çš„å®ç°ï¼Œå®ƒç›´æ¥ä¼ é€’åŸå§‹æŸ¥è¯¢è€Œä¸è¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚

#### å‹ç¼©æŸ¥è¯¢è½¬æ¢å™¨

`CompressingQueryTransformer` ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å‹ç¼©æŸ¥è¯¢å’Œå¯¹è¯ä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆä¸€ä¸ªæ›´ç®€æ´ã€ç‹¬ç«‹çš„æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š

```
ç”¨æˆ·ï¼šå‘Šè¯‰æˆ‘å…³äºJohn Doeçš„ä¿¡æ¯ã€‚
AIï¼šJohn Doe æ˜¯ä¸€ä¸ªè‘—åä½œå®¶ã€‚
ç”¨æˆ·ï¼šä»–ä½åœ¨å“ªé‡Œï¼Ÿ
```
å¯¹äº"ä»–ä½åœ¨å“ªé‡Œï¼Ÿ"è¿™æ ·çš„æŸ¥è¯¢ï¼Œ`CompressingQueryTransformer` ä¼šè‡ªåŠ¨è½¬æ¢ä¸º"John Doe ä½åœ¨å“ªé‡Œï¼Ÿ"ï¼Œä»¥ä¾¿æ›´ç²¾å‡†åœ°æ£€ç´¢ä¿¡æ¯ã€‚

#### æ‰©å±•æŸ¥è¯¢è½¬æ¢å™¨

`ExpandingQueryTransformer` å¯ä»¥å°†ç®€å•çš„æŸ¥è¯¢æ‰©å±•ä¸ºå¤šä¸ªä¸åŒçš„è¡¨è¾¾æ–¹å¼ï¼Œä»è€Œæé«˜ç›¸å…³å†…å®¹çš„è¦†ç›–é¢ã€‚

### å†…å®¹ï¼ˆContentï¼‰

`Content` ä»£è¡¨ç³»ç»Ÿä»æ•°æ®æºä¸­æ£€ç´¢åˆ°çš„ä¸æŸ¥è¯¢ç›¸å…³çš„å†…å®¹ã€‚ç›®å‰æ”¯æŒçš„ä¸»è¦æ˜¯æ–‡æœ¬å†…å®¹ï¼ˆ`TextSegment`ï¼‰ï¼Œæœªæ¥å¯èƒ½ä¼šæ‰©å±•æ”¯æŒå…¶ä»–æ¨¡æ€ï¼Œå¦‚å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ç­‰ã€‚

### å†…å®¹æ£€ç´¢å™¨ï¼ˆContent Retrieverï¼‰

`ContentRetriever` æ ¹æ®ç”¨æˆ·çš„æŸ¥è¯¢ä»åº•å±‚æ•°æ®æºä¸­è·å–å†…å®¹ï¼Œæ•°æ®æºå¯ä»¥æ˜¯ï¼š
- åµŒå…¥å‘é‡å­˜å‚¨
- å…¨æ–‡æœç´¢å¼•æ“
- å‘é‡ä¸å…¨æ–‡æ£€ç´¢ç»“åˆ
- ç½‘ç»œæœç´¢å¼•æ“
- SQLæ•°æ®åº“
- çŸ¥è¯†å›¾è°±ç­‰

#### åµŒå…¥å­˜å‚¨å†…å®¹æ£€ç´¢å™¨

`EmbeddingStoreContentRetriever` ä½¿ç”¨åµŒå…¥æ¨¡å‹å°†æŸ¥è¯¢è½¬åŒ–ä¸ºå‘é‡ï¼Œå¹¶ä»åµŒå…¥å­˜å‚¨ä¸­æ£€ç´¢ç›¸å…³çš„å†…å®¹ã€‚

**ç¤ºä¾‹ä»£ç ï¼š**
```java
EmbeddingStore embeddingStore = ...
EmbeddingModel embeddingModel = ...

ContentRetriever contentRetriever = EmbeddingStoreContentRetriever.builder()
    .embeddingStore(embeddingStore)
    .embeddingModel(embeddingModel)
    .maxResults(3)   // è¿”å›æœ€å¤š3æ¡ç»“æœ
    .dynamicMaxResults(query -> 3)  // æ ¹æ®æŸ¥è¯¢åŠ¨æ€æŒ‡å®šmaxResults
    .minScore(0.75)  // è¿‡æ»¤åˆ†æ•°ä½äº0.75çš„å†…å®¹
    .dynamicMinScore(query -> 0.75)  // æ ¹æ®æŸ¥è¯¢åŠ¨æ€æŒ‡å®šminScore
    .filter(metadataKey("userId").isEqualTo("12345"))  // è¿‡æ»¤æŒ‡å®šç”¨æˆ·çš„å†…å®¹
    .dynamicFilter(query -> {
        String userId = getUserId(query.metadata().chatMemoryId());
        return metadataKey("userId").isEqualTo(userId);  // åŠ¨æ€è¿‡æ»¤
    })
    .build();
```

#### ç½‘ç»œæœç´¢å†…å®¹æ£€ç´¢å™¨

`WebSearchContentRetriever` é€šè¿‡ `WebSearchEngine` ä»äº’è”ç½‘ä¸Šæ£€ç´¢ç›¸å…³å†…å®¹ã€‚

**ç¤ºä¾‹ä»£ç ï¼š**
```java
WebSearchEngine googleSearchEngine = GoogleCustomWebSearchEngine.builder()
    .apiKey(System.getenv("GOOGLE_API_KEY"))
    .csi(System.getenv("GOOGLE_SEARCH_ENGINE_ID"))
    .build();

ContentRetriever contentRetriever = WebSearchContentRetriever.builder()
    .webSearchEngine(googleSearchEngine)
    .maxResults(3)
    .build();
```
æŸ¥çœ‹å®Œæ•´ç¤ºä¾‹è¯·å‚è€ƒ[è¿™é‡Œ](https://github.com/langchain4j/langchain4j-examples/blob/main/rag-examples/src/main/java/_3_advanced/_08_Advanced_RAG_Web_Search_Example.java)ã€‚

#### SQLæ•°æ®åº“å†…å®¹æ£€ç´¢å™¨

`SqlDatabaseContentRetriever` æ˜¯ç”¨äºä»SQLæ•°æ®åº“æ£€ç´¢æ•°æ®çš„å®éªŒæ€§å®ç°ã€‚æ›´å¤šä¿¡æ¯å¯å‚è€ƒç›¸å…³javadocæ–‡æ¡£ã€‚

#### Azure AI æœç´¢å†…å®¹æ£€ç´¢å™¨

`AzureAiSearchContentRetriever` åœ¨ `langchain4j-azure-ai-search` æ¨¡å—ä¸­å¯ç”¨ã€‚

#### Neo4jå†…å®¹æ£€ç´¢å™¨

`Neo4jContentRetriever` å¯ç”¨äºä»Neo4jæ•°æ®åº“ä¸­æ£€ç´¢ä¸æŸ¥è¯¢ç›¸å…³çš„å†…å®¹ã€‚

### æŸ¥è¯¢è·¯ç”±å™¨ï¼ˆQuery Routerï¼‰

`QueryRouter` è´Ÿè´£å°†æŸ¥è¯¢åˆ†é…åˆ°åˆé€‚çš„å†…å®¹æ£€ç´¢å™¨ã€‚

#### é»˜è®¤æŸ¥è¯¢è·¯ç”±å™¨

`DefaultQueryRouter` å°†æ¯ä¸ªæŸ¥è¯¢è·¯ç”±åˆ°æ‰€æœ‰é…ç½®çš„å†…å®¹æ£€ç´¢å™¨ã€‚

#### è¯­è¨€æ¨¡å‹æŸ¥è¯¢è·¯ç”±å™¨

`LanguageModelQueryRouter` ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å†³å®šåº”è¯¥å°†æŸ¥è¯¢å‘é€åˆ°å“ªä¸ªæ£€ç´¢å™¨ã€‚

### å¹¶è¡ŒåŒ–å¤„ç†

å½“åªæœ‰ä¸€ä¸ªæŸ¥è¯¢å’Œä¸€ä¸ªæ£€ç´¢å™¨æ—¶ï¼Œ`DefaultRetrievalAugmentor` ä¼šåœ¨å•çº¿ç¨‹ä¸­æ‰§è¡ŒæŸ¥è¯¢å’Œæ£€ç´¢ã€‚å¦åˆ™ï¼Œå®ƒä¼šä½¿ç”¨ `Executor` å¹¶è¡Œå¤„ç†å¤šä¸ªæŸ¥è¯¢å’Œæ£€ç´¢ä»»åŠ¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šä½¿ç”¨ä¸€ä¸ªä¿®æ”¹åçš„ `Executors.newCachedThreadPool()` æ¥å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œä½ ä¹Ÿå¯ä»¥æä¾›è‡ªå®šä¹‰çš„ `Executor`ï¼š
```java
DefaultRetrievalAugmentor augmentor = DefaultRetrievalAugmentor.builder()
    .executor(executor)
    .build();
```

<Card title="PIG AIåº”ç”¨å¼€å‘å¹³å° | é€‚åˆä¸­å¤§å‹ä¼ä¸šæ„å»ºè‡ªä¸»å¯æ§çš„AIä¸­å°" icon="link" href="https://ai.pig4cloud.com">
**ä¸ºJavaå¼€å‘è€…æä¾›å…¨æ ˆå¼AIå·¥ç¨‹åŒ–è§£å†³æ–¹æ¡ˆ**ï¼Œå¼ºç±»å‹/é«˜å¯ç»´æŠ¤æ€§æ¶æ„ï¼Œå†…ç½®30+ä¸»æµå¤§æ¨¡å‹æ”¯æŒã€‚

- **ğŸ” çŸ¥è¯†å¼•æ“ä½“ç³»**ï¼šRAG çŸ¥è¯†å¼•æ“å…¨è‡ªåŠ¨åŒ–å¤šæ¨¡æ€è§£å†³æ–¹æ¡ˆ
- **ğŸ“ AI-OCR ä¸­æ¢**ï¼šå¤æ‚éæ ‡åœºæ™¯é«˜ç²¾åº¦è¯†åˆ«
- **âš™ï¸ ä¸šåŠ¡æ™ºèƒ½èåˆ**ï¼šå‡½æ•°ç¼–æ’ + Chat2SQLï¼Œæ— ç¼å¯¹æ¥ç°æœ‰ä¸šåŠ¡ç³»ç»Ÿ
- **ğŸ›¡ï¸ Nç»´é£æ§ä½“ç³»**ï¼šæ•æ„Ÿè¯/IP/Token/User è§„åˆ™æ§åˆ¶å¼•æ“
</Card>

<Card title="æ–‡æ¡£æœ‰è¯¯ï¼Ÿè¯·ååŠ©ç¼–è¾‘" icon="pencil" href="https://github.com/javaai-pig4cloud-com/javaai-docs/edit/main/docs/15RAG API2.mdx">
  å‘ç°æ–‡æ¡£é—®é¢˜ï¼Ÿç‚¹å‡»æ­¤å¤„ç›´æ¥åœ¨ GitHub ä¸Šç¼–è¾‘å¹¶æäº¤ PRï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹è¿›æ–‡æ¡£ï¼
</Card>

<Card title="æ–‡æ¡£æœ‰è¯¯ï¼Ÿè¯·ååŠ©ç¼–è¾‘" icon="pencil" href="https://github.com/javaai-pig4cloud-com/javaai-docs/edit/main/docs/15-rag-api2.mdx">
  å‘ç°æ–‡æ¡£é—®é¢˜ï¼Ÿç‚¹å‡»æ­¤å¤„ç›´æ¥åœ¨ GitHub ä¸Šç¼–è¾‘å¹¶æäº¤ PRï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹è¿›æ–‡æ¡£ï¼
</Card>
