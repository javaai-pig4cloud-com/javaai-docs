---
title: "Azure Cosmos DB Vector Store"
---

# Azure Cosmos DB

This section walks you through setting up `CosmosDBVectorStore` to store document embeddings and perform similarity searches.

## What is Azure Cosmos DB?

[Azure Cosmos DB](https://azure.microsoft.com/en-us/services/cosmos-db/) is Microsoft's globally distributed cloud-native database service designed for mission-critical applications. It offers high availability, low latency, and the ability to scale horizontally to meet modern application demands.

<Accordion title="More about Azure Cosmos DB">
Azure Cosmos DB was built from the ground up with global distribution, fine-grained multi-tenancy, and horizontal scalability at its core. It is a foundational service in Azure, used by most of Microsoft's mission critical applications at global scale, including Teams, Skype, Xbox Live, Office 365, Bing, Azure Active Directory, Azure Portal, Microsoft Store, and many others. It is also used by thousands of external customers including OpenAI for ChatGPT and other mission-critical AI applications that require elastic scale, turnkey global distribution, and low latency and high availability across the planet.
</Accordion>

## What is DiskANN?

DiskANN (Disk-based Approximate Nearest Neighbor Search) is an innovative technology used in Azure Cosmos DB to enhance the performance of vector searches. It enables efficient and scalable similarity searches across high-dimensional data by indexing embeddings stored in Cosmos DB.

<CardGroup cols={1}>
  <Card title="Benefits of DiskANN" icon="chart-line">
    <ul>
      <li><strong>Efficiency</strong>: By utilizing disk-based structures, DiskANN significantly reduces the time required to find nearest neighbors compared to traditional methods.</li>
      <li><strong>Scalability</strong>: It can handle large datasets that exceed memory capacity, making it suitable for various applications, including machine learning and AI-driven solutions.</li>
      <li><strong>Low Latency</strong>: DiskANN minimizes latency during search operations, ensuring that applications can retrieve results quickly even with substantial data volumes.</li>
    </ul>
  </Card>
</CardGroup>

In the context of Spring AI for Azure Cosmos DB, vector searches will create and leverage DiskANN indexes to ensure optimal performance for similarity queries.

## Setting up Azure Cosmos DB Vector Store

### Auto Configuration

The following code demonstrates how to set up the `CosmosDBVectorStore` with auto-configuration:

```java
package com.example.demo;

import io.micrometer.observation.ObservationRegistry;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.ai.document.Document;
import org.springframework.ai.vectorstore.SearchRequest;
import org.springframework.ai.vectorstore.VectorStore;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Lazy;

import java.util.List;
import java.util.Map;
import java.util.UUID;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootApplication
@EnableAutoConfiguration
public class DemoApplication implements CommandLineRunner {

    private static final Logger log = LoggerFactory.getLogger(DemoApplication.class);

    @Lazy
    @Autowired
    private VectorStore vectorStore;

    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }

    @Override
    public void run(String... args) throws Exception {
        Document document1 = new Document(UUID.randomUUID().toString(), "Sample content1", Map.of("key1", "value1"));
        Document document2 = new Document(UUID.randomUUID().toString(), "Sample content2", Map.of("key2", "value2"));
        this.vectorStore.add(List.of(document1, document2));
        List<Document> results = this.vectorStore.similaritySearch(SearchRequest.builder().query("Sample content").topK(1).build());

        log.info("Search results: {}", results);

        // Remove the documents from the vector store
        this.vectorStore.delete(List.of(document1.getId(), document2.getId()));
    }

    @Bean
    public ObservationRegistry observationRegistry() {
        return ObservationRegistry.create();
    }
}
```

### Adding Dependencies

<Note>
There has been a significant change in the Spring AI auto-configuration and starter modules' artifact names.
Please refer to the [upgrade notes](https://docs.spring.io/spring-ai/reference/upgrade-notes.html) for more information.
</Note>

<Tabs>
  <Tab title="Maven">
```xml
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-starter-vector-store-azure-cosmos-db</artifactId>
</dependency>
```
  </Tab>
</Tabs>

## Configuration Properties

The following configuration properties are available for the Cosmos DB vector store:

<AccordionGroup>
  <Accordion title="Database Properties">
    <ul>
      <li><code>spring.ai.vectorstore.cosmosdb.databaseName</code>: The name of the Cosmos DB database to use.</li>
      <li><code>spring.ai.vectorstore.cosmosdb.containerName</code>: The name of the Cosmos DB container to use.</li>
      <li><code>spring.ai.vectorstore.cosmosdb.partitionKeyPath</code>: The path for the partition key.</li>
    </ul>
  </Accordion>
  <Accordion title="Vector Properties">
    <ul>
      <li><code>spring.ai.vectorstore.cosmosdb.metadataFields</code>: Comma-separated list of metadata fields.</li>
      <li><code>spring.ai.vectorstore.cosmosdb.vectorStoreThroughput</code>: The throughput for the vector store.</li>
      <li><code>spring.ai.vectorstore.cosmosdb.vectorDimensions</code>: The number of dimensions for the vectors.</li>
    </ul>
  </Accordion>
  <Accordion title="Authentication Properties">
    <ul>
      <li><code>spring.ai.vectorstore.cosmosdb.endpoint</code>: The endpoint for the Cosmos DB.</li>
      <li><code>spring.ai.vectorstore.cosmosdb.key</code>: The key for the Cosmos DB (if key is not present, <a href="https://learn.microsoft.com/azure/developer/java/sdk/authentication/credential-chains#defaultazurecredential-overview">DefaultAzureCredential</a> will be used).</li>
    </ul>
  </Accordion>
</AccordionGroup>

## Complex Searches with Filters

You can perform more complex searches using filters in the Cosmos DB vector store. Below is a sample demonstrating how to use filters in your search queries:

```java
Map<String, Object> metadata1 = new HashMap<>();
metadata1.put("country", "UK");
metadata1.put("year", 2021);
metadata1.put("city", "London");

Map<String, Object> metadata2 = new HashMap<>();
metadata2.put("country", "NL");
metadata2.put("year", 2022);
metadata2.put("city", "Amsterdam");

Document document1 = new Document("1", "A document about the UK", this.metadata1);
Document document2 = new Document("2", "A document about the Netherlands", this.metadata2);

vectorStore.add(List.of(document1, document2));

FilterExpressionBuilder builder = new FilterExpressionBuilder();
List<Document> results = vectorStore.similaritySearch(SearchRequest.builder().query("The World")
    .topK(10)
    .filterExpression((this.builder.in("country", "UK", "NL")).build()).build());
```

## Manual Configuration

<Tip>
Using [DefaultAzureCredential](https://learn.microsoft.com/azure/developer/java/sdk/authentication/credential-chains#defaultazurecredential-overview) is recommended for authentication to Azure Cosmos DB.
</Tip>

The following code demonstrates how to set up the `CosmosDBVectorStore` without relying on auto-configuration:

```java
@Bean
public VectorStore vectorStore(ObservationRegistry observationRegistry) {
    // Create the Cosmos DB client
    CosmosAsyncClient cosmosClient = new CosmosClientBuilder()
            .endpoint(System.getenv("COSMOSDB_AI_ENDPOINT"))
            .credential(new DefaultAzureCredentialBuilder().build())
            .userAgentSuffix("SpringAI-CDBNoSQL-VectorStore")
            .gatewayMode()
            .buildAsyncClient();

    // Create and configure the vector store
    return CosmosDBVectorStore.builder(cosmosClient, embeddingModel)
            .databaseName("test-database")
            .containerName("test-container")
            // Configure metadata fields for filtering
            .metadataFields(List.of("country", "year", "city"))
            // Set the partition key path (optional)
            .partitionKeyPath("/id")
            // Configure performance settings
            .vectorStoreThroughput(1000)
            .vectorDimensions(1536)  // Match your embedding model's dimensions
            // Add custom batching strategy (optional)
            .batchingStrategy(new TokenCountBatchingStrategy())
            // Add observation registry for metrics
            .observationRegistry(observationRegistry)
            .build();
}

@Bean
public EmbeddingModel embeddingModel() {
    return new TransformersEmbeddingModel();
}
```

<AccordionGroup>
  <Accordion title="Builder Configuration Options">
    <ul>
      <li><code>databaseName</code>: The name of your Cosmos DB database</li>
      <li><code>containerName</code>: The name of your container within the database</li>
      <li><code>partitionKeyPath</code>: The path for the partition key (e.g., "/id")</li>
      <li><code>metadataFields</code>: List of metadata fields that will be used for filtering</li>
      <li><code>vectorStoreThroughput</code>: The throughput (RU/s) for the vector store container</li>
      <li><code>vectorDimensions</code>: The number of dimensions for your vectors (should match your embedding model)</li>
      <li><code>batchingStrategy</code>: Strategy for batching document operations (optional)</li>
    </ul>
  </Accordion>
</AccordionGroup>

### Manual Dependency Setup

<Tabs>
  <Tab title="Maven">
```xml
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-azure-cosmos-db-store</artifactId>
</dependency>
```
  </Tab>
</Tabs>

## Accessing the Native Client

The Azure Cosmos DB Vector Store implementation provides access to the underlying native Azure Cosmos DB client (`CosmosClient`) through the `getNativeClient()` method:

```java
CosmosDBVectorStore vectorStore = context.getBean(CosmosDBVectorStore.class);
Optional<CosmosClient> nativeClient = vectorStore.getNativeClient();

if (nativeClient.isPresent()) {
    CosmosClient client = nativeClient.get();
    // Use the native client for Azure Cosmos DB-specific operations
}
```

<Warning>
The native client gives you access to Azure Cosmos DB-specific features and operations that might not be exposed through the `VectorStore` interface. Use with caution.
</Warning> 